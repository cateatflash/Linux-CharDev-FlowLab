<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ç”±æµ…å…¥æ·±ï¼šå­—ç¬¦è®¾å¤‡é©±åŠ¨æ¡†æ¶äº¤äº’åŠ¨ç”»ï¼ˆç”¨æˆ·æ€ â‡„ å†…æ ¸æ€ï¼‰</title>
  <style>
    :root{
      --bg:#0b1020;
      --panel:#101a33;
      --panel2:#13555f;
      --text:#e7ecff;
      --muted:#aeb8e6;
      --line:rgba(255,255,255,.12);
      --accent:#7aa2ff;
      --good:#3ddc97;
      --warn:#ffcc66;
      --bad:#ff6b6b;
      --kernel:#1b2a5a;
      --user:#1f4b3a;
      --chip:#0c1533;
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Noto Sans", "PingFang SC", "Microsoft Yahei", sans-serif;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:var(--sans);
      color:var(--text);
      background: radial-gradient(1200px 800px at 15% 15%, rgba(122,162,255,.15), transparent 60%),
                  radial-gradient(900px 600px at 85% 25%, rgba(61,220,151,.12), transparent 55%),
                  radial-gradient(900px 700px at 40% 95%, rgba(255,204,102,.10), transparent 55%),
                  var(--bg);
      min-height:100vh;
    }

    header{
      padding:22px 18px 10px;
      max-width:1200px;
      margin:0 auto;
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:14px;
    }
    .title{
      display:flex;
      flex-direction:column;
      gap:6px;
    }
    .title h1{margin:0;font-size:18px;letter-spacing:.2px}
    .title p{margin:0;color:var(--muted);font-size:13px;line-height:1.35}

    .kbd{
      font-family:var(--mono);
      font-size:12px;
      color:rgba(231,236,255,.9);
      background:rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.10);
      padding:2px 6px;
      border-radius:7px;
      display:inline-block;
    }

    .wrap{
      max-width:1200px;
      margin:0 auto;
      padding:0 18px 24px;
      display:grid;
      grid-template-columns: 1.1fr .9fr;
      gap:14px;
    }

    .card{
      background:linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
      border:1px solid rgba(255,255,255,.10);
      border-radius:16px;
      box-shadow:var(--shadow);
      overflow:hidden;
    }
    .card .hd{
      padding:12px 14px;
      border-bottom:1px solid rgba(255,255,255,.10);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      background:rgba(255,255,255,.03);
    }
    .card .hd .left{display:flex;align-items:center;gap:10px}
    .badge{
      font-size:11px;
      padding:2px 8px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.16);
      background:rgba(255,255,255,.06);
      color:rgba(231,236,255,.92);
    }
    .badge.kernel{border-color:rgba(122,162,255,.35); background:rgba(122,162,255,.12)}
    .badge.user{border-color:rgba(61,220,151,.35); background:rgba(61,220,151,.12)}

    .btnrow{display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end}
    button{
      cursor:pointer;
      border:1px solid rgba(255,255,255,.16);
      background:rgba(255,255,255,.06);
      color:var(--text);
      padding:8px 10px;
      border-radius:12px;
      font-size:13px;
      transition:transform .05s ease, background .2s ease, border-color .2s ease;
      user-select:none;
    }
    button:hover{background:rgba(255,255,255,.10)}
    button:active{transform:translateY(1px)}
    button.primary{border-color:rgba(122,162,255,.35); background:rgba(122,162,255,.14)}
    button.primary:hover{background:rgba(122,162,255,.20)}
    button.danger{border-color:rgba(255,107,107,.35); background:rgba(255,107,107,.14)}
    button.danger:hover{background:rgba(255,107,107,.20)}
    button:disabled{opacity:.45; cursor:not-allowed}

    .content{padding:14px}

    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .mini{
      background:rgba(0,0,0,.18);
      border:1px solid rgba(255,255,255,.10);
      border-radius:14px;
      overflow:hidden;
    }
    .mini .mh{padding:10px 12px;border-bottom:1px solid rgba(255,255,255,.10);color:rgba(231,236,255,.92);font-size:12px;background:rgba(255,255,255,.03)}
    .mini .mb{padding:10px 12px;color:var(--muted);font-size:12px;line-height:1.45}

    .diagram{
      height:720px;
      position:relative;
      background:linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.00));
    }
    .lane{
      position:absolute;
      top:14px;
      bottom:14px;
      width:calc(50% - 18px);
      border-radius:16px;
      border:1px solid rgba(255,255,255,.10);
      padding:12px;
      overflow:hidden;
    }
    .lane.user{left:14px;background:linear-gradient(180deg, rgba(61,220,151,.10), rgba(0,0,0,.12))}
    .lane.kernel{right:14px;background:linear-gradient(180deg, rgba(122,162,255,.12), rgba(0,0,0,.12))}
    .lane h3{margin:0 0 10px;font-size:12px;color:rgba(231,236,255,.92);display:flex;align-items:center;gap:10px;flex-wrap:wrap}
    .lane h3 span{color:var(--muted);font-weight:500;flex:1 1 100%;font-size:11px}

    .node{
      position:relative;
      border-radius:16px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(0,0,0,.18);
      padding:10px 10px 9px;
      margin:10px 0;
      box-shadow: 0 10px 25px rgba(0,0,0,.22);
      transition: outline .2s ease, transform .2s ease, border-color .2s ease;
    }
    .node .t{font-size:12px;color:rgba(231,236,255,.95);display:flex;align-items:center;gap:8px}
    .node .s{margin-top:6px;font-family:var(--mono);font-size:11px;color:rgba(231,236,255,.68)}

    .node[data-kind="obj"]{border-style:dashed}

    .hl{
      outline:2px solid rgba(255,255,255,.0);
    }
    .hl.active{
      outline-color: rgba(255,204,102,.8);
      transform: translateY(-1px);
      border-color: rgba(255,204,102,.55);
    }

    .arrowlayer{
      position:absolute; inset:0;
      pointer-events:none;
    }

    /* right column */
    .steps{
      max-height:540px;
      overflow:auto;
      padding:0;
      margin:0;
      list-style:none;
    }
    .step{
      padding:12px 14px;
      border-bottom:1px solid rgba(255,255,255,.08);
      display:flex;
      gap:10px;
      align-items:flex-start;
      cursor:pointer;
      background:transparent;
      transition:background .2s ease;
    }
    .step:hover{background:rgba(255,255,255,.04)}
    .step.active{background:rgba(255,204,102,.12)}
    .step .n{
      width:24px;height:24px;border-radius:9px;
      display:grid;place-items:center;
      background:rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.12);
      color:rgba(231,236,255,.9);
      font-family:var(--mono);
      font-size:12px;
      flex:0 0 auto;
    }
    .step .meta{flex:1}
    .step .meta .h{font-size:12px;color:rgba(231,236,255,.95)}
    .step .meta .d{margin-top:6px;font-size:12px;color:var(--muted);line-height:1.45}

    .console{
      background:rgba(0,0,0,.25);
      border:1px solid rgba(255,255,255,.10);
      border-radius:14px;
      overflow:hidden;
      margin-top:12px;
    }
    .console .ch{padding:10px 12px;border-bottom:1px solid rgba(255,255,255,.10);font-size:12px;color:rgba(231,236,255,.92);display:flex;justify-content:space-between;align-items:center;background:rgba(255,255,255,.03)}
    .console pre{
      margin:0;
      padding:10px 12px;
      max-height:180px;
      overflow:auto;
      font-family:var(--mono);
      font-size:11px;
      color:rgba(231,236,255,.80);
      line-height:1.55;
      white-space:pre-wrap;
    }

    .inspector{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
      margin-top:12px;
    }

    .kv{
      display:grid;
      grid-template-columns: 120px 1fr;
      gap:8px;
      align-items:center;
      padding:8px 10px;
      border-bottom:1px solid rgba(255,255,255,.08);
    }
    .kv:last-child{border-bottom:none}
    .k{color:rgba(231,236,255,.86);font-size:12px}
    .v{color:var(--muted);font-family:var(--mono);font-size:11px;word-break:break-word}

    .pill{
      display:inline-flex;align-items:center;gap:6px;
      padding:2px 8px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(255,255,255,.06);
      font-size:11px;
      color:rgba(231,236,255,.92);
    }
    .dot{width:8px;height:8px;border-radius:50%}
    .dot.good{background:var(--good)}
    .dot.bad{background:var(--bad)}
    .dot.warn{background:var(--warn)}
    .dot.kernel{background:var(--accent)}

    .footer{
      max-width:1200px;
      margin:0 auto;
      padding:0 18px 18px;
      color:var(--muted);
      font-size:12px;
      line-height:1.45;
    }
    .footer code{font-family:var(--mono); font-size:11px}

    /* flow builder */
    .flow-wrap{margin-top:14px;grid-template-columns:1fr}
    .flow-grid{display:grid;grid-template-columns:.9fr 1.2fr .9fr;gap:12px}
    .flow-panel .mini{height:100%}
    .flow-tip{color:var(--muted);font-size:11px;line-height:1.45;margin-bottom:8px}
    .flow-canvas{
      min-height:420px;
      border:1px dashed rgba(255,255,255,.16);
      border-radius:14px;
      padding:10px;
      background:rgba(0,0,0,.16);
    }
    .flow-palette,.flow-list{display:flex;flex-direction:column;gap:8px}
    .flow-empty{color:var(--muted);font-size:12px;padding:12px 6px}
    .flow-card{
      border-radius:12px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(0,0,0,.18);
      padding:10px;
      cursor:grab;
      box-shadow:0 8px 18px rgba(0,0,0,.2);
      transition:border-color .2s ease, transform .2s ease, outline .2s ease;
    }
    .palette-card{cursor:pointer}
    .flow-card:active{cursor:grabbing}
    .flow-card.active{outline:2px solid rgba(255,204,102,.75);border-color:rgba(255,204,102,.55)}
    .flow-card.dragging{opacity:.45}
    .flow-card[data-domain="user"]{border-color:rgba(61,220,151,.35)}
    .flow-card[data-domain="kernel"]{border-color:rgba(122,162,255,.35)}
    .flow-card .top{display:flex;align-items:center;justify-content:space-between;gap:8px}
    .flow-card .name{font-family:var(--mono);font-size:12px;color:rgba(231,236,255,.95)}
    .flow-card .desc{margin-top:6px;font-size:11px;color:var(--muted);line-height:1.4}
    button.flow-remove{
      padding:2px 6px;
      border-radius:8px;
      font-size:11px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(255,255,255,.04);
    }
    .flow-status{display:flex;flex-wrap:wrap;gap:8px;margin-bottom:8px}

    /* responsive */
    @media (max-width: 980px){
      .wrap{grid-template-columns:1fr;}
      .diagram{height:640px}
      .steps{max-height:420px}
      .inspector{grid-template-columns:1fr}
      .flow-grid{grid-template-columns:1fr}
      .flow-canvas{min-height:320px}
    }
  </style>
</head>
<body>
<header>
  <div class="title">
    <h1>å­—ç¬¦è®¾å¤‡é©±åŠ¨æ¡†æ¶äº¤äº’åŠ¨ç”»ï¼šä» <span class="kbd">insmod</span> åˆ° <span class="kbd">open()</span> è¿›å…¥ <span class="kbd">.open</span></h1>
    <p>
      ç”¨â€œå•æ­¥è°ƒè¯•â€çš„æ–¹å¼ç†è§£ï¼šè®¾å¤‡å·(dev_t) â†’ cdev â†’ fops â†’ /dev èŠ‚ç‚¹ â†’ VFS è·¯ç”±ã€‚<br>
      å¿«æ·é”®ï¼š<span class="kbd">â†’</span> ä¸‹ä¸€æ­¥ / <span class="kbd">â†</span> ä¸Šä¸€æ­¥ / <span class="kbd">Space</span> æ’­æ”¾æš‚åœ / <span class="kbd">R</span> é‡ç½®
    </p>
  </div>
  <div class="btnrow">
    <button id="btnPrev">â† ä¸Šä¸€æ­¥</button>
    <button id="btnNext" class="primary">ä¸‹ä¸€æ­¥ â†’</button>
    <button id="btnPlay">â–¶ æ’­æ”¾</button>
    <button id="btnReset" class="danger">é‡ç½®</button>
  </div>
</header>

<div class="wrap">
  <!-- left: diagram -->
  <section class="card">
    <div class="hd">
      <div class="left">
        <span class="badge user">ç”¨æˆ·æ€</span>
        <span class="badge kernel">å†…æ ¸æ€</span>
        <span class="badge" id="phaseBadge">é˜¶æ®µï¼šæ³¨å†Œçº¿</span>
      </div>
      <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap;justify-content:flex-end">
        <span class="pill"><span class="dot warn"></span> å½“å‰é«˜äº®</span>
        <span class="pill"><span class="dot good"></span> å·²å»ºç«‹</span>
        <span class="pill"><span class="dot bad"></span> æœªå»ºç«‹</span>
      </div>
    </div>
    <div class="content diagram" id="diagram">
      <svg class="arrowlayer" id="arrows" viewBox="0 0 1000 560" preserveAspectRatio="none">
        <defs>
          <marker id="arrowHead" viewBox="0 0 10 10" refX="9" refY="5" markerWidth="7" markerHeight="7" orient="auto-start-reverse">
            <path d="M 0 0 L 10 5 L 0 10 z" fill="rgba(255,204,102,.9)"></path>
          </marker>
          <filter id="glow" x="-50%" y="-50%" width="200%" height="200%">
            <feGaussianBlur stdDeviation="2" result="coloredBlur"/>
            <feMerge>
              <feMergeNode in="coloredBlur"/>
              <feMergeNode in="SourceGraphic"/>
            </feMerge>
          </filter>
        </defs>
        <path id="animPath" d="" stroke="rgba(255,204,102,.9)" stroke-width="2.5" fill="none" marker-end="url(#arrowHead)" filter="url(#glow)" stroke-dasharray="7 7" />
      </svg>

      <div class="lane user" id="laneUser">
        <h3>ç”¨æˆ·æ€ <span>ï¼ˆshell / app / udevï¼‰</span></h3>

        <div class="node hl" id="u_insmod">
          <div class="t">ğŸ§© insmod</div>
          <div class="s">ç”¨æˆ·æ€åŠ è½½æ¨¡å— â†’ è§¦å‘å†…æ ¸æ‰§è¡Œ module_init()</div>
        </div>

        <div class="node hl" id="u_udev" data-kind="obj">
          <div class="t">ğŸ›  udev / mdev</div>
          <div class="s">ç›‘å¬ uevent â†’ mknod/chmod åˆ›å»º /dev èŠ‚ç‚¹</div>
        </div>

        <div class="node hl" id="u_app">
          <div class="t">ğŸ“¦ app</div>
          <div class="s">open("/dev/LED") / write(fd, 1)</div>
        </div>

        <div class="node hl" id="u_devnode" data-kind="obj">
          <div class="t">ğŸšª /dev/LED</div>
          <div class="s">å­—ç¬¦è®¾å¤‡èŠ‚ç‚¹ï¼šåªå­˜ dev_t(major:minor)</div>
        </div>
      </div>

      <div class="lane kernel" id="laneKernel">
        <h3>å†…æ ¸æ€ <span>ï¼ˆVFS / chrdev / sysfsï¼‰</span></h3>

        <div class="node hl" id="k_module">
          <div class="t">ğŸ§ module_init()</div>
          <div class="s">é©±åŠ¨å…¥å£ï¼šç”³è¯·è®¾å¤‡å·ã€cdev_addã€device_create</div>
        </div>

        <div class="node hl" id="k_devt" data-kind="obj">
          <div class="t">ğŸ· dev_tï¼ˆmajor:minorï¼‰</div>
          <div class="s">é—¨ç‰Œå·ï¼šå†³å®šâ€œæ‰¾å“ªä¸ªå­—ç¬¦è®¾å¤‡â€</div>
        </div>

        <div class="node hl" id="k_cdev" data-kind="obj">
          <div class="t">ğŸ§­ cdevï¼ˆå­—ç¬¦è®¾å¤‡å®ä½“ï¼‰</div>
          <div class="s">dev_t â†’ fops çš„æ˜ å°„å…¥å£ï¼ˆcdev_add å»ºç«‹ï¼‰</div>
        </div>

        <div class="node hl" id="k_fops" data-kind="obj">
          <div class="t">ğŸ“œ file_operationsï¼ˆfopsï¼‰</div>
          <div class="s">.open/.read/.write å‡½æ•°æŒ‡é’ˆè¡¨</div>
        </div>

        <div class="node hl" id="k_sysfs" data-kind="obj">
          <div class="t">ğŸ—‚ sysfs (/sys/class/...)</div>
          <div class="s">device_create ç”Ÿæˆè®¾å¤‡å¯¹è±¡ + dev æ–‡ä»¶ + uevent</div>
        </div>

        <div class="node hl" id="k_vfs">
          <div class="t">ğŸ§± VFS</div>
          <div class="s">open è·¯å¾„è§£æ â†’ inode(i_rdev) â†’ chrdev è·¯ç”±</div>
        </div>

        <div class="node hl" id="k_driver">
          <div class="t">ğŸ”Œ ä½ çš„é©±åŠ¨å‡½æ•°</div>
          <div class="s">char_open / char_write / copy_from_user</div>
        </div>
      </div>
    </div>
  </section>

  <!-- right: stepper + inspector -->
  <section class="card">
    <div class="hd">
      <div class="left">
        <span class="badge" id="stepBadge">æ­¥éª¤ 1/12</span>
        <span class="badge" id="modeBadge">æ¨¡å¼ï¼šå•æ­¥è°ƒè¯•</span>
      </div>
      <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap;justify-content:flex-end">
        <span class="pill" id="domainPill"><span class="dot warn"></span><span id="domainText">å½“å‰ï¼šç”¨æˆ·æ€ â†’ å†…æ ¸æ€</span></span>
      </div>
    </div>

    <div class="content">
      <div class="grid2">
        <div class="mini">
          <div class="mh">æœ¬æ­¥åœ¨è®²ä»€ä¹ˆ</div>
          <div class="mb" id="stepExplain">â€”</div>
        </div>
        <div class="mini">
          <div class="mh">æœ¬æ­¥ä½ èƒ½â€œè§‚å¯Ÿåˆ°ä»€ä¹ˆâ€</div>
          <div class="mb" id="stepObserve">â€”</div>
        </div>
      </div>

      <div class="console">
        <div class="ch">
          <div>â€œä¼ª dmesg / ä¼ª straceâ€è¾“å‡º</div>
          <button id="btnClearLog" style="padding:6px 10px;border-radius:10px;font-size:12px">æ¸…ç©º</button>
        </div>
        <pre id="log"></pre>
      </div>

      <div class="inspector">
        <div class="mini">
          <div class="mh">å¯¹è±¡æ£€æŸ¥å™¨ï¼ˆå½“å‰ç³»ç»ŸçŠ¶æ€ï¼‰</div>
          <div class="mb" style="padding:0">
            <div class="kv"><div class="k">dev_t</div><div class="v" id="st_devt">æœªåˆ†é…</div></div>
            <div class="kv"><div class="k">cdev_add</div><div class="v" id="st_cdev">æœªå»ºç«‹</div></div>
            <div class="kv"><div class="k">fops ç»‘å®š</div><div class="v" id="st_fops">æœªç»‘å®š</div></div>
            <div class="kv"><div class="k">sysfs è®¾å¤‡</div><div class="v" id="st_sysfs">ä¸å­˜åœ¨</div></div>
            <div class="kv"><div class="k">/dev èŠ‚ç‚¹</div><div class="v" id="st_devnode">ä¸å­˜åœ¨</div></div>
            <div class="kv"><div class="k">file->f_op</div><div class="v" id="st_fileop">æœªè®¾ç½®</div></div>
          </div>
        </div>

        <div class="mini">
          <div class="mh">â€œè°ƒç”¨æ ˆâ€æ¨¡æ‹Ÿï¼ˆå¸®åŠ©ä½ è„‘å†…è°ƒè¯•ï¼‰</div>
          <div class="mb" style="padding:0">
            <div class="kv"><div class="k">ç”¨æˆ·æ€</div><div class="v" id="stack_user">(ç©º)</div></div>
            <div class="kv"><div class="k">å†…æ ¸æ€</div><div class="v" id="stack_kernel">(ç©º)</div></div>
            <div class="kv"><div class="k">å¤‡æ³¨</div><div class="v" id="stack_note">â€”</div></div>
          </div>
        </div>
      </div>

      <div class="mini" style="margin-top:12px">
        <div class="mh">æ­¥éª¤åˆ—è¡¨ï¼ˆå¯ç‚¹å‡»è·³è½¬ï¼‰</div>
        <ul class="steps" id="steps"></ul>
      </div>

    </div>
  </section>
</div>

<div class="wrap flow-wrap">
  <section class="card" id="flowBuilder">
    <div class="hd">
      <div class="left">
        <span class="badge">æ–°å»ºä»£ç æµä»¿çœŸ</span>
        <span class="badge" id="flowModeBadge">æ¨¡å¼ï¼šç¼–è¾‘</span>
      </div>
      <div class="btnrow">
        <button id="btnFlowSample">è½½å…¥ç¤ºä¾‹</button>
        <button id="btnFlowStep" class="primary">å•æ­¥</button>
        <button id="btnFlowPlay">æ’­æ”¾</button>
        <button id="btnFlowReset">é‡ç½®</button>
        <button id="btnFlowClear" class="danger">æ¸…ç©º</button>
      </div>
    </div>
    <div class="content flow-grid">
      <div class="flow-panel">
        <div class="mini">
          <div class="mh">å‡½æ•°å¡ç‰‡åº“</div>
          <div class="mb">
            <div class="flow-tip">ç‚¹å‡»å·¦ä¾§å‡½æ•°å¡ç‰‡æ·»åŠ åˆ°ä¸­é—´ç”»å¸ƒï¼Œå†æ‹–åŠ¨æ’åºç»„æˆå®Œæ•´æµç¨‹ã€‚</div>
            <div class="flow-palette" id="flowPalette"></div>
          </div>
        </div>
      </div>
      <div class="flow-panel">
        <div class="mini">
          <div class="mh">ä»£ç æµç”»å¸ƒï¼ˆå¯æ‹–åŠ¨æ’åºï¼‰</div>
          <div class="mb">
            <div class="flow-canvas" id="flowCanvas">
              <div class="flow-list" id="flowList"></div>
              <div class="flow-empty" id="flowEmpty">æç¤ºï¼šå…ˆç‚¹å‡»å¡ç‰‡æˆ–ç‚¹å‡»â€œè½½å…¥ç¤ºä¾‹â€</div>
            </div>
          </div>
        </div>
      </div>
      <div class="flow-panel">
        <div class="mini">
          <div class="mh">è°ƒè¯•è§†å›¾ï¼ˆå †æ ˆ / åˆ‡æ¢ / ç›¸å…³ä¿¡æ¯ï¼‰</div>
          <div class="mb">
            <div class="flow-status">
              <span class="pill" id="flowDomainPill"><span class="dot warn"></span><span id="flowDomainText">å½“å‰ï¼šæœªå¼€å§‹</span></span>
              <span class="pill" id="flowPhasePill">é˜¶æ®µï¼š-</span>
            </div>
            <div class="kv"><div class="k">å½“å‰å¡ç‰‡</div><div class="v" id="flowCurrent">ï¼ˆç©ºï¼‰</div></div>
            <div class="kv"><div class="k">è¯´æ˜</div><div class="v" id="flowExplain">-</div></div>
            <div class="kv"><div class="k">æ€åˆ‡æ¢</div><div class="v" id="flowSwitch">-</div></div>

            <div class="mini" style="margin-top:10px">
              <div class="mh">å †æ ˆå˜åŒ–</div>
              <div class="mb" style="padding:0">
                <div class="kv"><div class="k">ç”¨æˆ·æ€æ ˆ</div><div class="v" id="flowStackUser">(ç©º)</div></div>
                <div class="kv"><div class="k">å†…æ ¸æ€æ ˆ</div><div class="v" id="flowStackKernel">(ç©º)</div></div>
                <div class="kv"><div class="k">å¤‡æ³¨</div><div class="v" id="flowStackNote">-</div></div>
              </div>
            </div>

            <div class="mini" style="margin-top:10px">
              <div class="mh">çŠ¶æ€é¢æ¿</div>
              <div class="mb" style="padding:0">
                <div class="kv"><div class="k">dev_t</div><div class="v" id="flowStateDevt">æœªåˆ†é…</div></div>
                <div class="kv"><div class="k">cdev_add</div><div class="v" id="flowStateCdev">æœªå»ºç«‹</div></div>
                <div class="kv"><div class="k">fops ç»‘å®š</div><div class="v" id="flowStateFops">æœªç»‘å®š</div></div>
                <div class="kv"><div class="k">sysfs è®¾å¤‡</div><div class="v" id="flowStateSysfs">ä¸å­˜åœ¨</div></div>
                <div class="kv"><div class="k">/dev èŠ‚ç‚¹</div><div class="v" id="flowStateDevnode">ä¸å­˜åœ¨</div></div>
                <div class="kv"><div class="k">file->f_op</div><div class="v" id="flowStateFileop">æœªè®¾ç½®</div></div>
              </div>
            </div>

            <div class="console">
              <div class="ch">
                <div>ä»£ç æµæ—¥å¿—</div>
                <button id="btnFlowClearLog" style="padding:6px 10px;border-radius:10px;font-size:12px">æ¸…ç©º</button>
              </div>
              <pre id="flowLog"></pre>
            </div>
          </div>
        </div>
      </div>
    </div>
  </section>
</div>

<div class="footer">
  <p>
    ä½ å¯ä»¥æŠŠè¿™ä¸ªé¡µé¢å½“â€œäº¤äº’å¼æ³¨é‡Šâ€ï¼šæ¯ä¸€æ­¥éƒ½ä¼šé«˜äº®ç›¸å…³å¯¹è±¡ï¼Œå¹¶åœ¨å³ä¾§å±•ç¤ºâ€œæœ¬æ­¥è§£é‡Š / å¯è§‚å¯Ÿç°è±¡ / ä¼ªæ—¥å¿— / å¯¹è±¡çŠ¶æ€ / è°ƒç”¨æ ˆâ€ã€‚
    è‹¥ä½ æƒ³å¯¹æ¥çœŸå®ç¯å¢ƒï¼šæŠŠå³ä¾§çš„â€œå¯è§‚å¯Ÿç°è±¡â€å¯¹åº”åˆ°ä½ æ¿å­ä¸ŠçœŸå®å‘½ä»¤ï¼Œä¾‹å¦‚ï¼š<code>ls -l /dev/LED</code>ã€<code>cat /sys/class/chrdev_class/LED/dev</code>ã€<code>dmesg -w</code>ã€‚
  </p>
</div>

<script>
  // --- tiny helpers ---
  const $ = (id)=>document.getElementById(id);
  const clamp=(v,a,b)=>Math.max(a,Math.min(b,v));

  // --- simulated state ---
  const state = {
    devt: null,
    cdevAdded: false,
    fopsBound: false,
    sysfs: false,
    devnode: false,
    fileop: false,
    userStack: [],
    kernelStack: [],
    phase: 'æ³¨å†Œçº¿',
    playing: false,
    timer: null,
  };

  // --- steps definition ---
  const steps = [
    {
      title: 'ä»ç”¨æˆ·æ€å¼€å§‹ï¼šinsmod',
      domain: 'user->kernel',
      phase: 'æ³¨å†Œçº¿',
      explain: 'ä½ åœ¨ shell è¾“å…¥ insmod LED.koã€‚insmod æ˜¯ç”¨æˆ·æ€ç¨‹åºï¼Œå®ƒä¼šé€šè¿‡ç³»ç»Ÿè°ƒç”¨æŠŠæ¨¡å—äº¤ç»™å†…æ ¸åŠ è½½ã€‚',
      observe: 'ä½ èƒ½çœ‹åˆ°ï¼šdmesg é‡Œå‡ºç°æ¨¡å—åŠ è½½/æ‰“å°ä¿¡æ¯ï¼›æ­¤æ—¶ /dev/LED å¯èƒ½è¿˜ä¸å­˜åœ¨ã€‚',
      highlight: ['u_insmod','k_module'],
      path: ['u_insmod','k_module'],
      log: [
        '$ insmod LED.ko',
        '[kernel] finit_module(): load module into kernel',
        '[kernel] -> call module_init()'
      ],
      stack: {
        user: ['insmod'],
        kernel: ['finit_module','do_init_module','module_init'],
        note: 'ä»ç”¨æˆ·æ€è¿›å…¥å†…æ ¸æ€ï¼šç³»ç»Ÿè°ƒç”¨è§¦å‘æ¨¡å—åŠ è½½'
      }
    },
    {
      title: 'module_initï¼šç”³è¯·è®¾å¤‡å·ï¼ˆé™æ€/åŠ¨æ€ï¼‰',
      domain: 'kernel',
      phase: 'æ³¨å†Œçº¿',
      explain: 'é©±åŠ¨ init ä¸­å…ˆæ‹¿åˆ° dev_tï¼ˆé—¨ç‰Œå·ï¼‰ã€‚é™æ€ï¼šregister_chrdev_region(MKDEV(ma,mi))ï¼›åŠ¨æ€ï¼šalloc_chrdev_region(&dev).',
      observe: 'ä½ èƒ½çœ‹åˆ°ï¼šé©±åŠ¨ printk è¾“å‡º major/minorï¼›/proc/devices é‡Œå¯èƒ½å‡ºç°ä½ çš„è®¾å¤‡åã€‚',
      highlight: ['k_module','k_devt'],
      path: ['k_module','k_devt'],
      apply(){
        state.devt = '255:0 (ç¤ºä¾‹)';
      },
      log: [
        '[kernel] alloc_chrdev_region(&devt, 0, 1, "LED")',
        '[kernel] -> devt = (major=255, minor=0)'
      ],
      stack: {
        user: [],
        kernel: ['module_init','alloc_chrdev_region'],
        note: 'dev_t åªæ˜¯é—¨ç‰Œå·ï¼šæ­¤æ—¶è¿˜æ²¡æœ‰æŠŠé—¨ç‰Œå·æ˜ å°„åˆ°ä½ çš„ fops'
      }
    },
    {
      title: 'cdev_initï¼šæŠŠ fops äº¤ç»™ cdev',
      domain: 'kernel',
      phase: 'æ³¨å†Œçº¿',
      explain: 'cdev_init(&cdev, &fops) ç­‰ä»·äºâ€œæŠŠæœåŠ¡æ¸…å•(fops)äº¤ç»™æ¥çº¿å‘˜(cdev)â€ã€‚',
      observe: 'ä½ é€šå¸¸çœ‹ä¸åˆ°å¤–éƒ¨ç°è±¡ï¼Œä½†è¿™æ˜¯ä¹‹å open èƒ½è¿› .open çš„å‰æä¹‹ä¸€ã€‚',
      highlight: ['k_cdev','k_fops'],
      path: ['k_fops','k_cdev'],
      apply(){ state.fopsBound = true; },
      log: [
        '[kernel] cdev_init(&cdev, &file_operations)',
        '[kernel] -> cdev.ops = fops (open/read/write æŒ‡é’ˆè¡¨)'
      ],
      stack: {
        user: [],
        kernel: ['module_init','cdev_init'],
        note: 'æŠŠâ€œæ€ä¹ˆå¤„ç† open/writeâ€å…ˆæŒ‚åˆ° cdev ä¸Š'
      }
    },
    {
      title: 'cdev_addï¼šå»ºç«‹ dev_t â†’ cdev çš„æ˜ å°„ï¼ˆæœ€å…³é”®ï¼‰',
      domain: 'kernel',
      phase: 'æ³¨å†Œçº¿',
      explain: 'cdev_add(&cdev, devt, 1) æŠŠâ€œé—¨ç‰Œå·(dev_t)â€ç™»è®°åˆ°å†…æ ¸å­—ç¬¦è®¾å¤‡æ˜ å°„è¡¨ã€‚ä¹‹å VFS çœ‹åˆ° major/minor æ‰èƒ½æ‰¾åˆ°ä½ çš„ cdevã€‚',
      observe: 'æ­¤æ—¶ open æ‰â€œæœ‰æœºä¼šâ€è·¯ç”±åˆ°ä½ çš„ fopsï¼›ä½† /dev/LED å¯èƒ½ä»æœªå‡ºç°ï¼ˆè¿˜ç¼ºè®¾å¤‡èŠ‚ç‚¹ï¼‰ã€‚',
      highlight: ['k_devt','k_cdev'],
      path: ['k_devt','k_cdev'],
      apply(){ state.cdevAdded = true; },
      log: [
        '[kernel] cdev_add(&cdev, devt=255:0, count=1)',
        '[kernel] -> chrdev map: (255:0) => this cdev'
      ],
      stack: {
        user: [],
        kernel: ['module_init','cdev_add'],
        note: 'æ²¡æœ‰è¿™ä¸€æ­¥ï¼š/dev èŠ‚ç‚¹å°±ç®—å­˜åœ¨ï¼Œopen ä¹Ÿæ‰¾ä¸åˆ°ä½ çš„ fops'
      }
    },
    {
      title: 'class_createï¼šåœ¨ sysfs å»ºä¸€ä¸ªâ€œç±»åˆ«â€',
      domain: 'kernel',
      phase: 'æ³¨å†Œçº¿',
      explain: 'class_create åˆ›å»º /sys/class/chrdev_class/ã€‚å®ƒæ˜¯ç»™ç”¨æˆ·ç©ºé—´(udev)çœ‹çš„åå°æ¡£æ¡ˆæŸœã€‚',
      observe: 'ä½ èƒ½çœ‹åˆ°ï¼š/sys/class ä¸‹å‡ºç° chrdev_classã€‚',
      highlight: ['k_sysfs'],
      path: ['k_module','k_sysfs'],
      log: [
        '[kernel] class_create("chrdev_class")',
        '[kernel] -> /sys/class/chrdev_class created'
      ],
      stack: {
        user: [],
        kernel: ['module_init','class_create'],
        note: 'è¿™ä¸€æ­¥ä¸ç›´æ¥å½±å“ open è·¯ç”±ï¼Œä½†å½±å“ /dev èŠ‚ç‚¹æ˜¯å¦èƒ½è‡ªåŠ¨åˆ›å»º'
      }
    },
    {
      title: 'device_createï¼šç”Ÿæˆ sysfs è®¾å¤‡å¯¹è±¡å¹¶è§¦å‘ uevent',
      domain: 'kernel->user',
      phase: 'æ³¨å†Œçº¿',
      explain: 'device_create ä¼šåœ¨ /sys/class/chrdev_class/LED/ ä¸‹åˆ›å»ºè®¾å¤‡å¯¹è±¡ï¼Œå¹¶å†™å‡º dev æ–‡ä»¶(major:minor)ã€‚åŒæ—¶å‘ uevent é€šçŸ¥ç”¨æˆ·ç©ºé—´â€œæœ‰æ–°è®¾å¤‡â€ã€‚',
      observe: 'ä½ èƒ½çœ‹åˆ°ï¼š/sys/class/chrdev_class/LED/dev å†…å®¹ä¸º 255:0ã€‚',
      highlight: ['k_sysfs','u_udev'],
      path: ['k_sysfs','u_udev'],
      apply(){ state.sysfs = true; },
      log: [
        '[kernel] device_create(..., devt=255:0, name="LED")',
        '[kernel] -> /sys/class/chrdev_class/LED/dev = "255:0"',
        '[kernel] -> uevent: add@/class/chrdev_class/LED'
      ],
      stack: {
        user: ['udev listens uevent'],
        kernel: ['module_init','device_create','kobject_uevent'],
        note: 'ä»å†…æ ¸å‘æ¶ˆæ¯åˆ°ç”¨æˆ·æ€ï¼šudev/mdev ä¼šæ®æ­¤åˆ›å»º /dev èŠ‚ç‚¹'
      }
    },
    {
      title: 'udev/mdevï¼šåœ¨ç”¨æˆ·æ€åˆ›å»º /dev/LEDï¼ˆmknod/chmodï¼‰',
      domain: 'user->kernel',
      phase: 'æ³¨å†Œçº¿',
      explain: 'udev/mdev æ”¶åˆ° uevent åè¯»å– sysfs çš„ dev æ–‡ä»¶ï¼Œå¾—åˆ° major/minorï¼Œç„¶åè°ƒç”¨ mknod/chmodï¼ˆç³»ç»Ÿè°ƒç”¨å›åˆ°å†…æ ¸ï¼‰åœ¨ /dev ä¸‹åˆ›å»ºè®¾å¤‡èŠ‚ç‚¹ã€‚',
      observe: 'ä½ èƒ½çœ‹åˆ°ï¼š/dev/LED å‡ºç°ï¼›ls -l æ˜¾ç¤º crw... 255,0ã€‚',
      highlight: ['u_udev','u_devnode'],
      path: ['u_udev','u_devnode'],
      apply(){ state.devnode = true; },
      log: [
        '[user] udev: read /sys/class/chrdev_class/LED/dev -> 255:0',
        '[user] udev: mknod /dev/LED c 255 0',
        '[kernel] mknodat(): create char dev node with i_rdev=255:0',
        '[user] udev: chmod 0666 /dev/LED'
      ],
      stack: {
        user: ['udev','mknod','chmod'],
        kernel: ['mknodat','vfs_create'],
        note: 'è¿™æ˜¯ç»å…¸çš„â€œå†…æ ¸â†’ç”¨æˆ·â†’å†…æ ¸â€é—­ç¯'
      }
    },
    {
      title: 'åˆ‡åˆ°è°ƒç”¨çº¿ï¼šapp è°ƒç”¨ open("/dev/LED")',
      domain: 'user->kernel',
      phase: 'è°ƒç”¨çº¿',
      explain: 'ç”¨æˆ·æ€ app è°ƒ open("/dev/LED")ã€‚VFS è§£æè·¯å¾„æ‰¾åˆ° /dev/LED çš„ inodeï¼Œå‘ç°å®ƒæ˜¯å­—ç¬¦è®¾å¤‡ï¼Œå¹¶ä» inode->i_rdev è¯»å‡º major/minorã€‚',
      observe: 'ä½ èƒ½çœ‹åˆ°ï¼šå¦‚æœé©±åŠ¨ .open é‡Œ printkï¼Œè¿™ä¸€æ­¥ä¼šè§¦å‘ printkï¼ˆåé¢å‡ æ­¥å®Œæˆåï¼‰ã€‚',
      highlight: ['u_app','u_devnode','k_vfs'],
      path: ['u_devnode','k_vfs'],
      log: [
        '[user] fd = open("/dev/LED", O_RDWR)',
        '[kernel] vfs_open(): lookup path -> inode',
        '[kernel] inode->i_mode = S_IFCHR, inode->i_rdev = 255:0'
      ],
      stack: {
        user: ['app:open'],
        kernel: ['sys_openat','do_sys_open','do_filp_open','vfs_open'],
        note: 'open çš„å…³é”®è¾“å…¥å°±æ˜¯ i_rdev(é—¨ç‰Œå·)'
      }
    },
    {
      title: 'VFS è·¯ç”±ï¼šç”¨ major/minor æ‰¾åˆ° cdev',
      domain: 'kernel',
      phase: 'è°ƒç”¨çº¿',
      explain: 'VFS çœ‹åˆ° S_IFCHR åï¼Œä¼šè¿›å…¥å­—ç¬¦è®¾å¤‡æ‰“å¼€è·¯å¾„ï¼šæ ¹æ® (major,minor) å» chrdev æ˜ å°„è¡¨æŸ¥æ‰¾å¯¹åº”çš„ cdevï¼ˆä½ ä¹‹å‰ cdev_add å»ºç«‹çš„æ˜ å°„ï¼‰ã€‚',
      observe: 'å¦‚æœæ²¡æœ‰ cdev_addï¼šè¿™é‡Œä¼šå¤±è´¥ï¼Œopen è¿”å›é”™è¯¯ã€‚',
      highlight: ['k_vfs','k_cdev','k_devt'],
      path: ['k_vfs','k_cdev'],
      log: [
        '[kernel] chrdev_open(): lookup chrdev map by 255:0',
        '[kernel] -> found cdev for 255:0'
      ],
      stack: {
        user: [],
        kernel: ['vfs_open','chrdev_open','kobj_lookup'],
        note: 'cdev æ˜¯â€œé—¨ç‰Œå·â†’æœåŠ¡æ¸…å•â€çš„å…¥å£'
      }
    },
    {
      title: 'file->f_op = cdev->opsï¼ˆfops è£…è½½åˆ°æœ¬æ¬¡ open çš„ file å¯¹è±¡ï¼‰',
      domain: 'kernel',
      phase: 'è°ƒç”¨çº¿',
      explain: 'æ‰¾åˆ° cdev åï¼Œå†…æ ¸ä¼šæŠŠä½ çš„ fops èµ‹ç»™ file->f_opã€‚ä¹‹å write/read ç›´æ¥èµ° file->f_op->write/readã€‚',
      observe: 'ä½ èƒ½ç†è§£ï¼šä¸ºä»€ä¹ˆ open ä¸€æ¬¡åï¼Œåç»­ write æ›´å¿«ï¼ˆä¸å¿…å†æŸ¥æ˜ å°„ï¼‰ã€‚',
      highlight: ['k_fops','k_vfs'],
      path: ['k_cdev','k_fops'],
      apply(){ state.fileop = true; },
      log: [
        '[kernel] file->f_op = cdev->ops',
        '[kernel] -> file now holds pointers: .open/.write/...' 
      ],
      stack: {
        user: [],
        kernel: ['chrdev_open','set_fops'],
        note: 'è¿™ä¸€æ­¥ä¹‹åï¼Œwrite(fd,...) ä¼šç›´æ¥è·³åˆ°ä½ çš„ .write'
      }
    },
    {
      title: 'è°ƒç”¨ä½ çš„ .openï¼ˆè¿›å…¥é©±åŠ¨å‡½æ•°ï¼‰',
      domain: 'kernel',
      phase: 'è°ƒç”¨çº¿',
      explain: 'å†…æ ¸æœ€åè°ƒç”¨ file->f_op->open(...)ï¼Œä¹Ÿå°±æ˜¯ä½ çš„ char_open()ã€‚ä»æ­¤ä½ å°±èƒ½åœ¨ open é‡Œåˆå§‹åŒ–ç¡¬ä»¶/åˆ†é… private_data ç­‰ã€‚',
      observe: 'ä½ èƒ½çœ‹åˆ°ï¼šdmesg é‡Œå‡ºç° "open successful"ã€‚',
      highlight: ['k_driver'],
      path: ['k_vfs','k_driver'],
      log: [
        '[kernel] call fops->open(inode, file)',
        '[driver] char_open(): printk("open successful")'
      ],
      stack: {
        user: [],
        kernel: ['vfs_open','chrdev_open','fops->open','char_open'],
        note: 'open å·²å®Œæˆï¼šfile ç»“æ„ä½“å·²ç»‘å®š fops'
      }
    },
    {
      title: 'write(fd, 1)ï¼šè¿›å…¥ä½ çš„ .writeï¼ˆcopy_from_userï¼‰',
      domain: 'user->kernel',
      phase: 'è°ƒç”¨çº¿',
      explain: 'ç”¨æˆ·æ€ write(fd, "\x01", 1)ã€‚å†…æ ¸é€šè¿‡ file->f_op->write ç›´æ¥è·³åˆ°ä½ çš„ char_write()ã€‚ä½ ç”¨ copy_from_user æŠŠç”¨æˆ·æ€æ•°æ®å®‰å…¨æ‹·åˆ°å†…æ ¸ï¼Œå†é©±åŠ¨ç¡¬ä»¶ã€‚',
      observe: 'ä½ èƒ½çœ‹åˆ°ï¼šLED å˜åŒ–ï¼ˆç¡¬ä»¶å±‚é¢ï¼‰+ dmesg æ‰“å°ï¼ˆå¦‚æœä½ æ‰“å°ï¼‰ã€‚',
      highlight: ['u_app','k_driver'],
      path: ['u_app','k_driver'],
      log: [
        '[user] write(fd, 1)',
        '[kernel] vfs_write() -> file->f_op->write',
        '[driver] char_write(): copy_from_user()',
        '[driver] led_switch(LEDON)'
      ],
      stack: {
        user: ['app:write'],
        kernel: ['sys_write','vfs_write','fops->write','char_write','copy_from_user'],
        note: 'write ä¸å†æŸ¥ dev_tâ†’cdevï¼Œå› ä¸º file->f_op å·²ç»è®¾ç½®å¥½äº†'
      }
    }
  ];

  // --- UI: render steps list ---
  const stepsEl = $('steps');
  steps.forEach((s, i)=>{
    const li = document.createElement('li');
    li.className = 'step';
    li.dataset.idx = i;
    li.innerHTML = `
      <div class="n">${i+1}</div>
      <div class="meta">
        <div class="h">${s.title}</div>
        <div class="d">${s.explain}</div>
      </div>
    `;
    li.addEventListener('click', ()=>gotoStep(i));
    stepsEl.appendChild(li);
  });

  // --- highlight helpers ---
  const allNodes = [
    'u_insmod','u_udev','u_app','u_devnode',
    'k_module','k_devt','k_cdev','k_fops','k_sysfs','k_vfs','k_driver'
  ].map($);

  function clearHighlights(){
    allNodes.forEach(n=>n.classList.remove('active'));
  }

  function setHighlights(ids){
    clearHighlights();
    ids.forEach(id=>{ const el=$(id); if(el) el.classList.add('active'); });
  }

  // --- arrow drawing between nodes ---
  function centerOf(el){
    const r = el.getBoundingClientRect();
    const host = $('diagram').getBoundingClientRect();
    // map to svg viewBox coords (1000x560)
    const x = ( (r.left + r.right)/2 - host.left ) / host.width * 1000;
    const y = ( (r.top + r.bottom)/2 - host.top ) / host.height * 560;
    return {x, y};
  }

  function drawPath(fromId, toId){
    const from = $(fromId), to = $(toId);
    if(!from || !to) return;
    const a = centerOf(from);
    const b = centerOf(to);
    const midx = (a.x + b.x)/2;
    // curve
    const d = `M ${a.x} ${a.y} C ${midx} ${a.y}, ${midx} ${b.y}, ${b.x} ${b.y}`;
    $('animPath').setAttribute('d', d);
  }

  // --- log ---
  function appendLog(lines){
    const log = $('log');
    const now = lines.map(x=>x).join('\n') + '\n';
    log.textContent += now;
    log.scrollTop = log.scrollHeight;
  }

  function setLog(lines){
    $('log').textContent = lines.join('\n') + (lines.length?'\n':'');
    $('log').scrollTop = $('log').scrollHeight;
  }

  // --- inspector ---
  function renderState(){
    $('st_devt').textContent = state.devt ?? 'æœªåˆ†é…';
    $('st_cdev').innerHTML = state.cdevAdded
      ? '<span class="pill"><span class="dot good"></span>å·²å»ºç«‹</span>'
      : '<span class="pill"><span class="dot bad"></span>æœªå»ºç«‹</span>';
    $('st_fops').innerHTML = state.fopsBound
      ? '<span class="pill"><span class="dot good"></span>å·²ç»‘å®š</span>'
      : '<span class="pill"><span class="dot bad"></span>æœªç»‘å®š</span>';
    $('st_sysfs').innerHTML = state.sysfs
      ? '<span class="pill"><span class="dot good"></span>å­˜åœ¨</span>'
      : '<span class="pill"><span class="dot bad"></span>ä¸å­˜åœ¨</span>';
    $('st_devnode').innerHTML = state.devnode
      ? '<span class="pill"><span class="dot good"></span>å­˜åœ¨</span>'
      : '<span class="pill"><span class="dot bad"></span>ä¸å­˜åœ¨</span>';
    $('st_fileop').innerHTML = state.fileop
      ? '<span class="pill"><span class="dot good"></span>å·²è®¾ç½®</span>'
      : '<span class="pill"><span class="dot bad"></span>æœªè®¾ç½®</span>';

    $('stack_user').textContent = state.userStack.length ? state.userStack.join(' â†’ ') : '(ç©º)';
    $('stack_kernel').textContent = state.kernelStack.length ? state.kernelStack.join(' â†’ ') : '(ç©º)';
    $('phaseBadge').textContent = `é˜¶æ®µï¼š${state.phase}`;
  }

  // --- step engine ---
  let idx = 0;

  function resetState(){
    state.devt = null;
    state.cdevAdded = false;
    state.fopsBound = false;
    state.sysfs = false;
    state.devnode = false;
    state.fileop = false;
    state.userStack = [];
    state.kernelStack = [];
    state.phase = 'æ³¨å†Œçº¿';
  }

  function applyUpTo(i){
    resetState();
    const logs=[];
    for(let k=0;k<=i;k++){
      const s = steps[k];
      if(s.apply) s.apply();
      if(s.stack){
        state.userStack = s.stack.user ? [...s.stack.user] : [];
        state.kernelStack = s.stack.kernel ? [...s.stack.kernel] : [];
        $('stack_note').textContent = s.stack.note ?? 'â€”';
      }
      state.phase = s.phase;
      if(s.log) logs.push(...s.log);
    }
    setLog(logs);
  }

  function renderStep(i){
    i = clamp(i, 0, steps.length-1);
    idx = i;
    const s = steps[i];

    $('btnPrev').disabled = (i===0);
    $('btnNext').disabled = (i===steps.length-1);

    $('stepBadge').textContent = `æ­¥éª¤ ${i+1}/${steps.length}`;
    $('stepExplain').textContent = s.explain;
    $('stepObserve').textContent = s.observe;

    // domain pill
    const domainText = {
      'kernel':'å½“å‰ï¼šå†…æ ¸æ€',
      'user':'å½“å‰ï¼šç”¨æˆ·æ€',
      'user->kernel':'å½“å‰ï¼šç”¨æˆ·æ€ â†’ å†…æ ¸æ€',
      'kernel->user':'å½“å‰ï¼šå†…æ ¸æ€ â†’ ç”¨æˆ·æ€'
    }[s.domain] || `å½“å‰ï¼š${s.domain}`;
    $('domainText').textContent = domainText;

    // step list highlight
    [...stepsEl.children].forEach((li, k)=>{
      li.classList.toggle('active', k===i);
    });

    // highlight nodes + draw arrow
    setHighlights(s.highlight || []);
    if(s.path && s.path.length>=2) drawPath(s.path[0], s.path[1]);

    // apply state up to step
    applyUpTo(i);
    renderState();

    // update â€œæ¨¡å¼â€æç¤º
    $('modeBadge').textContent = state.playing ? 'æ¨¡å¼ï¼šæ’­æ”¾ä¸­' : 'æ¨¡å¼ï¼šå•æ­¥è°ƒè¯•';
  }

  function gotoStep(i){
    stop();
    renderStep(i);
  }

  function next(){
    if(idx < steps.length-1) renderStep(idx+1);
  }

  function prev(){
    if(idx > 0) renderStep(idx-1);
  }

  function play(){
    if(state.playing) return;
    state.playing = true;
    $('btnPlay').textContent = 'â¸ æš‚åœ';
    $('modeBadge').textContent = 'æ¨¡å¼ï¼šæ’­æ”¾ä¸­';
    state.timer = setInterval(()=>{
      if(idx >= steps.length-1){ stop(); return; }
      renderStep(idx+1);
    }, 1200);
  }

  function stop(){
    state.playing = false;
    $('btnPlay').textContent = 'â–¶ æ’­æ”¾';
    $('modeBadge').textContent = 'æ¨¡å¼ï¼šå•æ­¥è°ƒè¯•';
    if(state.timer) clearInterval(state.timer);
    state.timer = null;
  }

  function togglePlay(){
    if(state.playing) stop();
    else play();
  }

  function reset(){
    stop();
    $('stack_note').textContent = 'â€”';
    $('log').textContent = '';
    renderStep(0);
  }

  // --- buttons ---
  $('btnPrev').addEventListener('click', prev);
  $('btnNext').addEventListener('click', next);
  $('btnPlay').addEventListener('click', togglePlay);
  $('btnReset').addEventListener('click', reset);
  $('btnClearLog').addEventListener('click', ()=>setLog([]));

  // --- keyboard ---
  window.addEventListener('keydown', (e)=>{
    if(e.key === 'ArrowRight') { e.preventDefault(); next(); }
    if(e.key === 'ArrowLeft')  { e.preventDefault(); prev(); }
    if(e.key === ' ') { e.preventDefault(); togglePlay(); }
    if(e.key.toLowerCase() === 'r') { e.preventDefault(); reset(); }
  });

  // initial render after layout
  window.addEventListener('load', ()=>{
    renderStep(0);
    // redraw path on resize
    window.addEventListener('resize', ()=>{
      const s = steps[idx];
      if(s.path && s.path.length>=2) drawPath(s.path[0], s.path[1]);
    });
    initFlowBuilder();
  });

  // --- flow builder: data & runtime ---
  const flowCards = [
    {
      id: 'insmod',
      title: 'insmod',
      domain: 'user',
      phase: 'æ³¨å†Œçº¿',
      desc: 'åŠ è½½æ¨¡å—ï¼Œè§¦å‘å†…æ ¸åˆå§‹åŒ–',
      explain: 'ç”¨æˆ·æ€æ‰§è¡Œ insmodï¼Œå†…æ ¸è¿›å…¥ module_init() å®Œæˆåˆå§‹åŒ–ã€‚',
      stack: { user: ['insmod'], kernel: ['finit_module','do_init_module','module_init'] },
      log: [
        '$ insmod LED.ko',
        '[kernel] finit_module()',
        '[kernel] module_init()'
      ],
      note: 'ä»ç”¨æˆ·æ€åˆ‡å…¥å†…æ ¸æ€çš„èµ·ç‚¹ã€‚'
    },
    {
      id: 'module_init',
      title: 'module_init',
      domain: 'kernel',
      phase: 'æ³¨å†Œçº¿',
      desc: 'é©±åŠ¨å…¥å£å‡½æ•°',
      explain: 'é©±åŠ¨åŠ è½½å…¥å£ï¼Œå¼€å§‹ç”³è¯·èµ„æºå¹¶æ³¨å†Œå­—ç¬¦è®¾å¤‡ã€‚',
      stack: { user: [], kernel: ['module_init'] },
      log: ['[kernel] module_init(): driver entry'],
      note: 'æ‰€æœ‰æ³¨å†ŒåŠ¨ä½œéƒ½ä»è¿™é‡Œå¼€å§‹ã€‚'
    },
    {
      id: 'alloc_chrdev_region',
      title: 'alloc_chrdev_region',
      domain: 'kernel',
      phase: 'æ³¨å†Œçº¿',
      desc: 'åŠ¨æ€åˆ†é…è®¾å¤‡å·',
      explain: 'ä¸ºå­—ç¬¦è®¾å¤‡åˆ†é… major/minorã€‚',
      stack: { user: [], kernel: ['module_init','alloc_chrdev_region'] },
      log: ['[kernel] alloc_chrdev_region(&devt, 0, 1, "LED")'],
      note: 'dev_t æ˜¯é—¨ç‰Œå·ï¼Œæœ¬èº«å¹¶ä¸ç­‰äºè®¾å¤‡å¯¹è±¡ã€‚',
      apply(state){ state.devt = '255:0 (ç¤ºä¾‹)'; }
    },
    {
      id: 'cdev_init',
      title: 'cdev_init',
      domain: 'kernel',
      phase: 'æ³¨å†Œçº¿',
      desc: 'ç»‘å®š fops',
      explain: 'æŠŠ file_operations ä¸ cdev ç»‘å®šã€‚',
      stack: { user: [], kernel: ['module_init','cdev_init'] },
      log: ['[kernel] cdev_init(&cdev, &fops)'],
      note: 'å†³å®š open/read/write æŒ‡å‘å“ªäº›å‡½æ•°ã€‚',
      apply(state){ state.fopsBound = true; }
    },
    {
      id: 'cdev_add',
      title: 'cdev_add',
      domain: 'kernel',
      phase: 'æ³¨å†Œçº¿',
      desc: 'æ³¨å†Œ cdev',
      explain: 'å»ºç«‹ dev_t -> cdev çš„æ˜ å°„ã€‚',
      stack: { user: [], kernel: ['module_init','cdev_add'] },
      log: ['[kernel] cdev_add(&cdev, devt, 1)'],
      note: 'VFS æ ¹æ® major/minor æ‰¾åˆ° cdevã€‚',
      apply(state){ state.cdevAdded = true; }
    },
    {
      id: 'class_create',
      title: 'class_create',
      domain: 'kernel',
      phase: 'æ³¨å†Œçº¿',
      desc: 'åˆ›å»º class',
      explain: 'åˆ›å»º /sys/class ä¸‹çš„ç±»ç›®å½•ï¼Œä¾›ç”¨æˆ·æ€æŸ¥çœ‹ã€‚',
      stack: { user: [], kernel: ['module_init','class_create'] },
      log: ['[kernel] class_create("chrdev_class")'],
      note: 'ä¸º device_create æä¾›å®¹å™¨ã€‚'
    },
    {
      id: 'device_create',
      title: 'device_create',
      domain: 'kernel',
      phase: 'æ³¨å†Œçº¿',
      desc: 'åˆ›å»º device + uevent',
      explain: 'ç”Ÿæˆ /sys/class/.../dev å¹¶è§¦å‘ ueventã€‚',
      stack: { user: [], kernel: ['module_init','device_create','kobject_uevent'] },
      log: [
        '[kernel] device_create(..., devt=255:0, name="LED")',
        '[kernel] uevent: add@/class/chrdev_class/LED'
      ],
      note: 'udev/mdev ä¼šæ®æ­¤åˆ›å»º /dev èŠ‚ç‚¹ã€‚',
      apply(state){ state.sysfs = true; }
    },
    {
      id: 'udev_mknod',
      title: 'udev / mknod',
      domain: 'user',
      phase: 'æ³¨å†Œçº¿',
      desc: 'åˆ›å»º /dev èŠ‚ç‚¹',
      explain: 'ç”¨æˆ·æ€æ”¶åˆ° uevent åè°ƒç”¨ mknod/chmodã€‚',
      stack: { user: ['udev','mknod','chmod'], kernel: ['mknodat','vfs_create'] },
      log: [
        '[user] udev: mknod /dev/LED c 255 0',
        '[kernel] mknodat() -> create char dev node'
      ],
      note: 'å®Œæˆå /dev/LED å¯è¢« openã€‚',
      apply(state){ state.devnode = true; }
    },
    {
      id: 'open',
      title: 'open("/dev/LED")',
      domain: 'user',
      phase: 'è°ƒç”¨çº¿',
      desc: 'åº”ç”¨æ‰“å¼€è®¾å¤‡',
      explain: 'åº”ç”¨å‘èµ· open() ç³»ç»Ÿè°ƒç”¨ã€‚',
      stack: { user: ['app:open'], kernel: [] },
      log: ['[user] open("/dev/LED", O_RDWR)'],
      note: 'ç”¨æˆ·æ€ -> å†…æ ¸æ€åˆ‡æ¢å‘ç”Ÿåœ¨ sys_openatã€‚'
    },
    {
      id: 'sys_openat',
      title: 'sys_openat',
      domain: 'kernel',
      phase: 'è°ƒç”¨çº¿',
      desc: 'ç³»ç»Ÿè°ƒç”¨å…¥å£',
      explain: 'è¿›å…¥å†…æ ¸ï¼Œè§£æè·¯å¾„å¹¶å‡†å¤‡æ‰“å¼€æ–‡ä»¶ã€‚',
      stack: { user: [], kernel: ['sys_openat','do_sys_open'] },
      log: ['[kernel] sys_openat() -> do_sys_open()'],
      note: 'å†…æ ¸æ€å¼€å§‹æ¥ç®¡ open é€»è¾‘ã€‚'
    },
    {
      id: 'vfs_open',
      title: 'vfs_open',
      domain: 'kernel',
      phase: 'è°ƒç”¨çº¿',
      desc: 'VFS è§£æ',
      explain: 'å®šä½ inodeï¼Œåˆ¤æ–­ä¸ºå­—ç¬¦è®¾å¤‡ã€‚',
      stack: { user: [], kernel: ['do_filp_open','vfs_open'] },
      log: ['[kernel] vfs_open(): inode->i_rdev = 255:0'],
      note: 'å…³é”®æ˜¯ inode->i_rdevã€‚'
    },
    {
      id: 'chrdev_open',
      title: 'chrdev_open',
      domain: 'kernel',
      phase: 'è°ƒç”¨çº¿',
      desc: 'æŸ¥æ‰¾ cdev',
      explain: 'æ ¹æ® major/minor æŸ¥è¡¨æ‰¾åˆ° cdevã€‚',
      stack: { user: [], kernel: ['chrdev_open','kobj_lookup'] },
      log: ['[kernel] chrdev_open(): lookup cdev by 255:0'],
      note: 'ä¾èµ–å‰é¢çš„ cdev_addã€‚'
    },
    {
      id: 'set_fops',
      title: 'file->f_op = cdev->ops',
      domain: 'kernel',
      phase: 'è°ƒç”¨çº¿',
      desc: 'è£…è½½ fops',
      explain: 'æŠŠ fops å®‰è£…åˆ°å½“å‰ file å¯¹è±¡ã€‚',
      stack: { user: [], kernel: ['chrdev_open','set_fops'] },
      log: ['[kernel] file->f_op = cdev->ops'],
      note: 'åç»­ write/read ç›´æ¥èµ° fopsã€‚',
      apply(state){ state.fileop = true; }
    },
    {
      id: 'fops_open',
      title: 'fops->open',
      domain: 'kernel',
      phase: 'è°ƒç”¨çº¿',
      desc: 'è¿›å…¥é©±åŠ¨ open',
      explain: 'è°ƒç”¨ä½ å®ç°çš„ .open å‡½æ•°ã€‚',
      stack: { user: [], kernel: ['fops->open','driver_open'] },
      log: ['[driver] char_open(): printk("open ok")'],
      note: 'å¯åœ¨æ­¤åˆå§‹åŒ–ç¡¬ä»¶æˆ– private_dataã€‚'
    },
    {
      id: 'write',
      title: 'write(fd, 1)',
      domain: 'user',
      phase: 'è°ƒç”¨çº¿',
      desc: 'åº”ç”¨å†™è®¾å¤‡',
      explain: 'åº”ç”¨è°ƒç”¨ write() è¿›å…¥å†…æ ¸ã€‚',
      stack: { user: ['app:write'], kernel: [] },
      log: ['[user] write(fd, 1)'],
      note: 'çœŸæ­£æ‰§è¡Œåœ¨ sys_writeã€‚'
    },
    {
      id: 'sys_write',
      title: 'sys_write',
      domain: 'kernel',
      phase: 'è°ƒç”¨çº¿',
      desc: 'ç³»ç»Ÿè°ƒç”¨å…¥å£',
      explain: 'å†…æ ¸æ¥ç®¡ writeï¼Œè½¬å…¥ vfs_writeã€‚',
      stack: { user: [], kernel: ['sys_write','vfs_write'] },
      log: ['[kernel] sys_write() -> vfs_write()'],
      note: 'file->f_op å·²ç»å‡†å¤‡å¥½ã€‚'
    },
    {
      id: 'fops_write',
      title: 'fops->write',
      domain: 'kernel',
      phase: 'è°ƒç”¨çº¿',
      desc: 'è¿›å…¥é©±åŠ¨ write',
      explain: 'æ‰§è¡Œä½ å®ç°çš„ .write å‡½æ•°ã€‚',
      stack: { user: [], kernel: ['fops->write','driver_write'] },
      log: ['[driver] char_write(): handling data'],
      note: 'å¸¸è§ä¼šè°ƒç”¨ copy_from_userã€‚'
    },
    {
      id: 'copy_from_user',
      title: 'copy_from_user',
      domain: 'kernel',
      phase: 'è°ƒç”¨çº¿',
      desc: 'æ‹·è´ç”¨æˆ·æ•°æ®',
      explain: 'å®‰å…¨åœ°æŠŠç”¨æˆ·æ€æ•°æ®æ‹·è´åˆ°å†…æ ¸ç¼“å†²åŒºã€‚',
      stack: { user: [], kernel: ['copy_from_user'] },
      log: ['[kernel] copy_from_user()'],
      note: 'é¿å…ç›´æ¥è§£å¼•ç”¨ç”¨æˆ·æŒ‡é’ˆã€‚'
    },
    {
      id: 'rmmod',
      title: 'rmmod',
      domain: 'user',
      phase: 'å¸è½½çº¿',
      desc: 'å¸è½½æ¨¡å—',
      explain: 'ç”¨æˆ·æ€æ‰§è¡Œ rmmodï¼Œè§¦å‘ module_exitã€‚',
      stack: { user: ['rmmod'], kernel: ['delete_module','module_exit'] },
      log: ['[user] rmmod LED', '[kernel] module_exit()'],
      note: 'è¿›å…¥å¸è½½æµç¨‹ã€‚'
    },
    {
      id: 'module_exit',
      title: 'module_exit',
      domain: 'kernel',
      phase: 'å¸è½½çº¿',
      desc: 'é©±åŠ¨å‡ºå£å‡½æ•°',
      explain: 'é‡Šæ”¾èµ„æºå¹¶åæ³¨å†Œå­—ç¬¦è®¾å¤‡ã€‚',
      stack: { user: [], kernel: ['module_exit'] },
      log: ['[kernel] module_exit(): driver exit'],
      note: 'ä¸ module_init å½¢æˆé—­ç¯ã€‚'
    },
    {
      id: 'device_destroy',
      title: 'device_destroy',
      domain: 'kernel',
      phase: 'å¸è½½çº¿',
      desc: 'é”€æ¯ device',
      explain: 'åˆ é™¤ sysfs è®¾å¤‡å¯¹è±¡å¹¶å‘å‡º remove äº‹ä»¶ã€‚',
      stack: { user: [], kernel: ['device_destroy'] },
      log: ['[kernel] device_destroy()'],
      note: '/dev èŠ‚ç‚¹å¯èƒ½è¢« udev æ¸…ç†ã€‚',
      apply(state){ state.sysfs = false; state.devnode = false; }
    },
    {
      id: 'class_destroy',
      title: 'class_destroy',
      domain: 'kernel',
      phase: 'å¸è½½çº¿',
      desc: 'é”€æ¯ class',
      explain: 'æ¸…ç† /sys/class ä¸‹çš„ç±»ç›®å½•ã€‚',
      stack: { user: [], kernel: ['class_destroy'] },
      log: ['[kernel] class_destroy()'],
      note: 'é‡Šæ”¾ class èµ„æºã€‚'
    },
    {
      id: 'cdev_del',
      title: 'cdev_del',
      domain: 'kernel',
      phase: 'å¸è½½çº¿',
      desc: 'ç§»é™¤ cdev',
      explain: 'ä» chrdev æ˜ å°„è¡¨ä¸­åˆ é™¤ cdevã€‚',
      stack: { user: [], kernel: ['cdev_del'] },
      log: ['[kernel] cdev_del(&cdev)'],
      note: 'open å°†æ— æ³•å†å®šä½åˆ°é©±åŠ¨ã€‚',
      apply(state){ state.cdevAdded = false; state.fopsBound = false; state.fileop = false; }
    },
    {
      id: 'unregister_chrdev_region',
      title: 'unregister_chrdev_region',
      domain: 'kernel',
      phase: 'å¸è½½çº¿',
      desc: 'é‡Šæ”¾è®¾å¤‡å·',
      explain: 'é‡Šæ”¾ä¹‹å‰åˆ†é…çš„ dev_tã€‚',
      stack: { user: [], kernel: ['unregister_chrdev_region'] },
      log: ['[kernel] unregister_chrdev_region(devt, 1)'],
      note: 'è®¾å¤‡å·å½’è¿˜ç»™ç³»ç»Ÿã€‚',
      apply(state){ state.devt = null; }
    }
  ];

  const flowCardsById = Object.fromEntries(flowCards.map(c=>[c.id, c]));
  const flowDefault = [
    'insmod','module_init','alloc_chrdev_region','cdev_init','cdev_add',
    'class_create','device_create','udev_mknod',
    'open','sys_openat','vfs_open','chrdev_open','set_fops','fops_open',
    'write','sys_write','fops_write','copy_from_user'
  ];

  const flowState = {
    items: [],
    idx: -1,
    playing: false,
    timer: null,
    devt: null,
    cdevAdded: false,
    fopsBound: false,
    sysfs: false,
    devnode: false,
    fileop: false
  };

  let flowInstanceCounter = 0;
  const flowInstances = new Map();

  let flowEls = {};

  function initFlowBuilder(){
    flowEls = {
      palette: $('flowPalette'),
      list: $('flowList'),
      empty: $('flowEmpty'),
      modeBadge: $('flowModeBadge'),
      domainPill: $('flowDomainPill'),
      domainText: $('flowDomainText'),
      phasePill: $('flowPhasePill'),
      current: $('flowCurrent'),
      explain: $('flowExplain'),
      flowSwitch: $('flowSwitch'),
      stackUser: $('flowStackUser'),
      stackKernel: $('flowStackKernel'),
      stackNote: $('flowStackNote'),
      stateDevt: $('flowStateDevt'),
      stateCdev: $('flowStateCdev'),
      stateFops: $('flowStateFops'),
      stateSysfs: $('flowStateSysfs'),
      stateDevnode: $('flowStateDevnode'),
      stateFileop: $('flowStateFileop'),
      log: $('flowLog'),
      btnSample: $('btnFlowSample'),
      btnStep: $('btnFlowStep'),
      btnPlay: $('btnFlowPlay'),
      btnReset: $('btnFlowReset'),
      btnClear: $('btnFlowClear'),
      btnClearLog: $('btnFlowClearLog')
    };
    if(!flowEls.palette || !flowEls.list) return;

    renderFlowPalette();
    bindFlowDnD();

    flowEls.btnSample.addEventListener('click', loadFlowSample);
    flowEls.btnStep.addEventListener('click', flowNext);
    flowEls.btnPlay.addEventListener('click', flowTogglePlay);
    flowEls.btnReset.addEventListener('click', flowReset);
    flowEls.btnClear.addEventListener('click', flowClear);
    flowEls.btnClearLog.addEventListener('click', ()=>setFlowLog([]));

    flowReset();
  }

  function renderFlowPalette(){
    flowEls.palette.innerHTML = '';
    flowCards.forEach(card=>{
      const el = createFlowCard(card, null);
      el.classList.add('palette-card');
      el.addEventListener('click', ()=>addFlowCard(card.id, null));
      flowEls.palette.appendChild(el);
    });
  }

  function createFlowCard(card, instanceId){
    const el = document.createElement('div');
    el.className = 'flow-card';
    el.dataset.cardId = card.id;
    el.dataset.domain = card.domain;
    if(instanceId) el.dataset.instanceId = instanceId;
    el.innerHTML = `
      <div class="top">
        <div class="name">${card.title}</div>
        <span class="badge ${card.domain === 'kernel' ? 'kernel' : 'user'}">${card.domain === 'kernel' ? 'å†…æ ¸æ€' : 'ç”¨æˆ·æ€'}</span>
      </div>
      <div class="desc">${card.desc}</div>
    `;
    if(instanceId){
      el.draggable = true;
      const removeBtn = document.createElement('button');
      removeBtn.className = 'flow-remove';
      removeBtn.textContent = 'ç§»é™¤';
      removeBtn.addEventListener('click', (e)=>{
        e.stopPropagation();
        removeFlowCard(instanceId);
      });
      el.querySelector('.top').appendChild(removeBtn);
      el.addEventListener('dragstart', (e)=>{
        e.dataTransfer.setData('text/plain', instanceId);
        e.dataTransfer.effectAllowed = 'move';
        el.classList.add('dragging');
      });
      el.addEventListener('dragend', ()=>{
        el.classList.remove('dragging');
        syncFlowItems();
      });
    }
    return el;
  }

  function addFlowCard(cardId, insertBefore){
    const card = flowCardsById[cardId];
    if(!card) return;
    const instanceId = `flow_${++flowInstanceCounter}`;
    flowInstances.set(instanceId, card);
    const el = createFlowCard(card, instanceId);
    if(insertBefore){
      flowEls.list.insertBefore(el, insertBefore);
    }else{
      flowEls.list.appendChild(el);
    }
    syncFlowItems();
  }

  function removeFlowCard(instanceId){
    const el = flowEls.list.querySelector(`[data-instance-id="${instanceId}"]`);
    if(el) el.remove();
    flowInstances.delete(instanceId);
    syncFlowItems();
  }

  function bindFlowDnD(){
    flowEls.list.addEventListener('dragover', (e)=>{
      e.preventDefault();
      const dragging = flowEls.list.querySelector('.flow-card.dragging');
      const afterElement = getDragAfterElement(flowEls.list, e.clientY);
      if(dragging){
        if(afterElement == null){
          flowEls.list.appendChild(dragging);
        }else if(afterElement !== dragging){
          flowEls.list.insertBefore(dragging, afterElement);
        }
      }
    });

    flowEls.list.addEventListener('drop', (e)=>{
      e.preventDefault();
      const payload = e.dataTransfer.getData('text/plain');
      if(payload.startsWith('flow_')){
        syncFlowItems();
        return;
      }
      const afterElement = getDragAfterElement(flowEls.list, e.clientY);
      addFlowCard(payload, afterElement);
    });
  }

  function getDragAfterElement(container, y){
    const draggableElements = [...container.querySelectorAll('.flow-card:not(.dragging)')];
    return draggableElements.reduce((closest, child)=>{
      const box = child.getBoundingClientRect();
      const offset = y - box.top - box.height / 2;
      if(offset < 0 && offset > closest.offset){
        return { offset, element: child };
      }
      return closest;
    }, { offset: Number.NEGATIVE_INFINITY, element: null }).element;
  }

  function syncFlowItems(){
    flowStop();
    flowState.items = [...flowEls.list.querySelectorAll('.flow-card')]
      .map(el=>el.dataset.instanceId)
      .filter(Boolean);
    updateFlowEmpty();
    flowResetRuntime();
    flowRenderDebug(null, null);
    flowSetButtons();
  }

  function updateFlowEmpty(){
    flowEls.empty.style.display = flowState.items.length ? 'none' : 'block';
  }

  function flowResetRuntime(resetIndex = true){
    if(resetIndex) flowState.idx = -1;
    flowState.devt = null;
    flowState.cdevAdded = false;
    flowState.fopsBound = false;
    flowState.sysfs = false;
    flowState.devnode = false;
    flowState.fileop = false;
    setFlowLog([]);
    flowHighlight(null);
    flowRenderState();
  }

  function flowRenderState(){
    flowEls.stateDevt.textContent = flowState.devt ?? 'æœªåˆ†é…';
    flowEls.stateCdev.innerHTML = flowState.cdevAdded
      ? '<span class="pill"><span class="dot good"></span>å·²å»ºç«‹</span>'
      : '<span class="pill"><span class="dot bad"></span>æœªå»ºç«‹</span>';
    flowEls.stateFops.innerHTML = flowState.fopsBound
      ? '<span class="pill"><span class="dot good"></span>å·²ç»‘å®š</span>'
      : '<span class="pill"><span class="dot bad"></span>æœªç»‘å®š</span>';
    flowEls.stateSysfs.innerHTML = flowState.sysfs
      ? '<span class="pill"><span class="dot good"></span>å­˜åœ¨</span>'
      : '<span class="pill"><span class="dot bad"></span>ä¸å­˜åœ¨</span>';
    flowEls.stateDevnode.innerHTML = flowState.devnode
      ? '<span class="pill"><span class="dot good"></span>å­˜åœ¨</span>'
      : '<span class="pill"><span class="dot bad"></span>ä¸å­˜åœ¨</span>';
    flowEls.stateFileop.innerHTML = flowState.fileop
      ? '<span class="pill"><span class="dot good"></span>å·²è®¾ç½®</span>'
      : '<span class="pill"><span class="dot bad"></span>æœªè®¾ç½®</span>';
  }

  function flowSetButtons(){
    const hasItems = flowState.items.length > 0;
    flowEls.btnStep.disabled = !hasItems;
    flowEls.btnPlay.disabled = !hasItems;
    flowEls.btnReset.disabled = !hasItems;
  }

  function flowRenderDebug(card, prevCard){
    const domainText = card
      ? (card.domain === 'kernel' ? 'å½“å‰ï¼šå†…æ ¸æ€' : 'å½“å‰ï¼šç”¨æˆ·æ€')
      : 'å½“å‰ï¼šæœªå¼€å§‹';
    flowEls.domainText.textContent = domainText;
    flowEls.phasePill.textContent = `é˜¶æ®µï¼š${card ? card.phase : '-'}`;

    const dotEl = flowEls.domainPill.querySelector('.dot');
    dotEl.className = 'dot ' + (card ? (card.domain === 'kernel' ? 'kernel' : 'good') : 'warn');

    flowEls.current.textContent = card ? card.title : 'ï¼ˆç©ºï¼‰';
    flowEls.explain.textContent = card ? card.explain : '-';

    let switchText = '-';
    if(card){
      if(prevCard && prevCard.domain !== card.domain){
        switchText = `${prevCard.domain === 'kernel' ? 'å†…æ ¸æ€' : 'ç”¨æˆ·æ€'} â†’ ${card.domain === 'kernel' ? 'å†…æ ¸æ€' : 'ç”¨æˆ·æ€'}`;
      }else{
        switchText = `${card.domain === 'kernel' ? 'å†…æ ¸æ€' : 'ç”¨æˆ·æ€'}ï¼ˆä¿æŒï¼‰`;
      }
    }
    flowEls.flowSwitch.textContent = switchText;

    const stackUser = card?.stack?.user?.length ? card.stack.user.join(' â†’ ') : '(ç©º)';
    const stackKernel = card?.stack?.kernel?.length ? card.stack.kernel.join(' â†’ ') : '(ç©º)';
    flowEls.stackUser.textContent = stackUser;
    flowEls.stackKernel.textContent = stackKernel;
    flowEls.stackNote.textContent = card?.note ?? '-';

    flowRenderState();
  }

  function flowHighlight(instanceId){
    [...flowEls.list.querySelectorAll('.flow-card')].forEach(el=>{
      el.classList.toggle('active', el.dataset.instanceId === instanceId);
    });
  }

  function applyFlowUpTo(i){
    flowResetRuntime(false);
    const logs = [];
    for(let k=0;k<=i;k++){
      const instanceId = flowState.items[k];
      const card = flowInstances.get(instanceId);
      if(!card) continue;
      if(card.apply) card.apply(flowState);
      if(card.log) logs.push(...card.log);
    }
    setFlowLog(logs);
  }

  function flowNext(){
    if(flowState.items.length === 0) return;
    if(flowState.idx >= flowState.items.length - 1){
      flowStop();
      return;
    }
    const prevInstance = flowState.idx >= 0 ? flowState.items[flowState.idx] : null;
    flowState.idx += 1;
    const instanceId = flowState.items[flowState.idx];
    const card = flowInstances.get(instanceId);
    const prevCard = prevInstance ? flowInstances.get(prevInstance) : null;
    applyFlowUpTo(flowState.idx);
    flowRenderDebug(card, prevCard);
    flowHighlight(instanceId);
  }

  function flowPlay(){
    if(flowState.playing || flowState.items.length === 0) return;
    flowState.playing = true;
    flowEls.btnPlay.textContent = 'æš‚åœ';
    flowEls.modeBadge.textContent = 'æ¨¡å¼ï¼šæ’­æ”¾ä¸­';
    flowState.timer = setInterval(()=>{
      if(flowState.idx >= flowState.items.length - 1){
        flowStop();
        return;
      }
      flowNext();
    }, 1200);
  }

  function flowStop(){
    flowState.playing = false;
    flowEls.btnPlay.textContent = 'æ’­æ”¾';
    flowEls.modeBadge.textContent = 'æ¨¡å¼ï¼šç¼–è¾‘';
    if(flowState.timer) clearInterval(flowState.timer);
    flowState.timer = null;
  }

  function flowTogglePlay(){
    if(flowState.playing) flowStop();
    else flowPlay();
  }

  function flowReset(){
    flowStop();
    flowResetRuntime();
    flowRenderDebug(null, null);
    flowSetButtons();
  }

  function flowClear(){
    flowStop();
    flowEls.list.innerHTML = '';
    flowInstances.clear();
    flowState.items = [];
    updateFlowEmpty();
    flowResetRuntime();
    flowRenderDebug(null, null);
    flowSetButtons();
  }

  function loadFlowSample(){
    flowClear();
    flowDefault.forEach(id=>addFlowCard(id, null));
    flowResetRuntime();
    flowRenderDebug(null, null);
    flowSetButtons();
  }

  function setFlowLog(lines){
    flowEls.log.textContent = lines.join('\n') + (lines.length ? '\n' : '');
    flowEls.log.scrollTop = flowEls.log.scrollHeight;
  }
</script>
</body>
</html>
